<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DrinkQuick Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header { background: #4a00e0; color: white; padding: 20px; border-radius: 10px 10px 0 0; }
        .content { padding: 30px; }
        .auth-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .password-input { display: flex; gap: 10px; margin-top: 10px; }
        .password-input input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .password-input button { padding: 10px 20px; background: #4a00e0; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .message { padding: 10px; margin: 10px 0; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { text-align: center; padding: 20px; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DrinkQuick Admin Panel</h1>
            <p>Manage users and view statistics</p>
        </header>
        
        <div class="content">
            <div class="auth-section">
                <h2>Admin Login</h2>
                <p>Default password: <code>admin123</code> (or check Render environment variables)</p>
                <div class="password-input">
                    <input type="password" id="adminPassword" placeholder="Enter admin password" value="admin123">
                    <button id="loginBtn">Login</button>
                </div>
            </div>
            
            <div id="message" class="message"></div>
            <div id="loading" class="loading">Loading...</div>
            
            <div id="adminPanel" style="display: none;">
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div>Total Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="newToday">0</div>
                        <div>New Today</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <button id="loadUsersBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Load Users
                    </button>
                    <button id="refreshBtn" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                        Refresh
                    </button>
                </div>
                
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will appear here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Simple, reliable admin panel script
        const API_BASE = window.location.origin;
        let adminPassword = 'admin123';
        let usersData = [];

        // DOM elements
        const elements = {
            passwordInput: document.getElementById('adminPassword'),
            loginBtn: document.getElementById('loginBtn'),
            adminPanel: document.getElementById('adminPanel'),
            loadUsersBtn: document.getElementById('loadUsersBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            loading: document.getElementById('loading'),
            message: document.getElementById('message'),
            usersTableBody: document.getElementById('usersTableBody'),
            totalUsers: document.getElementById('totalUsers'),
            newToday: document.getElementById('newToday')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin panel loaded. API Base:', API_BASE);
            
            // Set up event listeners
            elements.loginBtn.addEventListener('click', login);
            elements.loadUsersBtn.addEventListener('click', loadUsers);
            elements.refreshBtn.addEventListener('click', loadUsers);
            
            // Auto-login if token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                elements.passwordInput.value = token;
                setTimeout(login, 500);
            }
            
            // Also allow Enter key to login
            elements.passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        function showMessage(text, type = 'success') {
            elements.message.textContent = text;
            elements.message.className = 'message ' + type;
            elements.message.style.display = 'block';
            setTimeout(() => {
                elements.message.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            elements.loading.style.display = show ? 'block' : 'none';
        }

        async function login() {
            adminPassword = elements.passwordInput.value.trim();
            if (!adminPassword) {
                showMessage('Please enter admin password', 'error');
                return;
            }
            
            showMessage('Authenticating...', 'success');
            
            try {
                // Test with stats endpoint first
                const response = await fetch(API_BASE + '/api/admin/stats', {
                    headers: {
                        'Authorization': 'Bearer ' + adminPassword,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Login response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Stats data:', data);
                    elements.totalUsers.textContent = data.totalUsers || 0;
                    elements.newToday.textContent = data.newToday || 0;
                    elements.adminPanel.style.display = 'block';
                    showMessage('Login successful!', 'success');
                    
                    // Auto-load users after successful login
                    setTimeout(loadUsers, 1000);
                } else {
                    const error = await response.text();
                    console.error('Login failed:', error);
                    showMessage('Login failed. Check password.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Network error. Is the server running?', 'error');
            }
        }

        async function loadUsers() {
            showLoading(true);
            elements.usersTableBody.innerHTML = '';
            
            try {
                console.log('Loading users with password:', adminPassword.substring(0, 3) + '...');
                
                const response = await fetch(API_BASE + '/api/admin/users', {
                    headers: {
                        'Authorization': 'Bearer ' + adminPassword,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Users response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Users data received:', data);
                    usersData = data.users || [];
                    
                    if (usersData.length === 0) {
                        elements.usersTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No users found</td></tr>';
                        showMessage('No users in database', 'info');
                    } else {
                        displayUsers(usersData);
                        showMessage('Loaded ' + usersData.length + ' users', 'success');
                    }
                    
                    // Update stats
                    updateStats();
                } else {
                    const error = await response.text();
                    console.error('Failed to load users:', error);
                    showMessage('Failed to load users', 'error');
                }
            } catch (error) {
                console.error('Load users error:', error);
                showMessage('Error loading users: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayUsers(users) {
            elements.usersTableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // Format date
                let joinDate = 'N/A';
                if (user.createdAt) {
                    const date = new Date(user.createdAt);
                    joinDate = date.toLocaleDateString();
                }
                
                // Get user initials for avatar
                const initials = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; background: #4a00e0; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                ${initials}
                            </div>
                            <div>
                                <strong>${user.name || 'Unknown'}</strong>
                                ${user.isAdmin ? '<br><small style="color: #4a00e0;">Admin</small>' : ''}
                            </div>
                        </div>
                    </td>
                    <td>${user.email || 'No email'}</td>
                    <td>${user.role || 'Customer'}</td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteUser('${user._id}', '${(user.name || user.email).replace(/'/g, "\\'")}')">
                            Delete
                        </button>
                    </td>
                `;
                
                elements.usersTableBody.appendChild(row);
            });
        }

        async function updateStats() {
            try {
                const response = await fetch(API_BASE + '/api/admin/stats', {
                    headers: {
                        'Authorization': 'Bearer ' + adminPassword,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    elements.totalUsers.textContent = data.totalUsers || 0;
                    elements.newToday.textContent = data.newToday || 0;
                }
            } catch (error) {
                console.error('Update stats error:', error);
            }
        }

        async function deleteUser(userId, userName) {
            if (!confirm('Are you sure you want to delete user: ' + userName + '?')) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/api/admin/users/' + userId, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + adminPassword,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showMessage('User deleted successfully', 'success');
                    // Reload users
                    loadUsers();
                } else {
                    const error = await response.text();
                    showMessage('Delete failed: ' + error, 'error');
                }
            } catch (error) {
                showMessage('Delete error: ' + error.message, 'error');
            }
        }

        // Make deleteUser available globally
        window.deleteUser = deleteUser;
    </script>
</body>
</html>
